<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Thêm responsive -->
    <title>Dự báo tiêu thụ điện 24h tới</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <style>
        body { background: linear-gradient(to bottom, #e0f7fa, #ffffff); min-height: 100vh; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .btn { font-size: 1.5rem; padding: 15px; border-radius: 10px; }
        .card { border-radius: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .spinner { display: none; text-align: center; margin-top: 20px; }
        #metrics-table { margin-top: 20px; }
        #reset-zoom { margin-top: 10px; float: right; }
    </style>
</head>
<body>
<div class="container py-5">
    <h1 class="text-center mb-5 text-primary fw-bold">DỰ BÁO TIÊU THỤ ĐIỆN NGẮN HẠN</h1>
    
    <!-- Phần upload dữ liệu mới (tích hợp đề tài: tải dữ liệu CSV) -->
    <div class="card mb-4 p-3">
        <h5 class="card-title">Tải dữ liệu CSV mới (PJME_hourly.csv)</h5>
        <input type="file" id="fileInput" class="form-control mb-2" accept=".csv">
        <button class="btn btn-secondary w-100" onclick="uploadFile()">TẢI LÊN DỮ LIỆU</button>
    </div>

    <div class="row g-4">
        <div class="col-md-6">
            <button class="btn btn-success btn-lg w-100" onclick="train()">HUẤN LUYỆN MÔ HÌNH</button>
        </div>
        <div class="col-md-6">
            <button class="btn btn-primary btn-lg w-100" onclick="predict()">DỰ BÁO 24H TỚI</button>
        </div>
    </div>

    <div id="result" class="mt-4 p-4 bg-white rounded shadow card" style="display:none;"></div>
    <div class="card mt-4 p-4 position-relative">
        <canvas id="chart" height="140"></canvas>
        <button id="reset-zoom" class="btn btn-outline-secondary btn-sm" onclick="resetZoom()" style="display:none;">Reset Zoom</button>
    </div>

    <!-- Spinner loading toàn cầu -->
    <div class="spinner" id="loading">
        <div class="spinner-border text-primary" role="status"></div>
        <span class="ms-2">Đang xử lý...</span>
    </div>
</div>

<script>
let chart;
const loading = document.getElementById('loading');
const resetBtn = document.getElementById('reset-zoom');

async function uploadFile() {
    loading.style.display = 'block';
    const file = document.getElementById('fileInput').files[0];
    if (!file) {
        alert("Vui lòng chọn file CSV!");
        loading.style.display = 'none';
        return;
    }
    const formData = new FormData();
    formData.append('file', file);

    try {
        const res = await fetch('/upload', { method: 'POST', body: formData });
        const data = await res.json();
        alert(data.success || data.error);
    } catch (e) {
        alert("Lỗi upload! Kiểm tra kết nối server.");
    } finally {
        loading.style.display = 'none';
    }
}

async function train() {
    loading.style.display = 'block';
    const btn = document.querySelector('.btn-success');
    btn.disabled = true;
    btn.innerHTML = 'ĐANG HUẤN LUYỆN... (20-40 giây)';
    
    try {
        const r = await fetch('/train');
        const t = await r.text();
        alert(t);
    } catch (e) {
        alert("Lỗi kết nối! Kiểm tra server còn chạy không?");
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'HUẤN LUYỆN MÔ HÌNH';
        loading.style.display = 'none';
    }
}

async function predict() {
    loading.style.display = 'block';
    const btn = document.querySelector('.btn-primary');
    btn.disabled = true;
    btn.innerHTML = 'ĐANG DỰ BÁO... (3-5 giây)';
    
    try {
        const res = await fetch('/predict');
        const data = await res.json();

        if (data.error) {
            alert(data.error);
            return;
        }

        // Hiển thị kết quả với metrics (giả sử BE trả thêm lr_mae, lstm_mae, v.v.)
        document.getElementById('result').style.display = 'block';
        document.getElementById('result').innerHTML = `
            <h3 class="text-success">KẾT QUẢ DỰ BÁO 24H TỚI</h3>
            <h2>Linear Regression: <span class="text-primary">${Number(data.linear_regression || 0).toLocaleString()} MW</span></h2>
            <h2>LSTM: <span class="text-danger">${Number(data.lstm || 0).toLocaleString()} MW</span></h2>
            <table id="metrics-table" class="table table-bordered mt-3">
                <thead class="table-light"><tr><th>Mô hình</th><th>MAE</th><th>RMSE</th><th>MAPE (%)</th></tr></thead>
                <tbody>
                    <tr><td>Linear Regression</td><td>${data.lr_mae || 'N/A'}</td><td>${data.lr_rmse || 'N/A'}</td><td>${data.lr_mape || 'N/A'}</td></tr>
                    <tr><td>LSTM</td><td>${data.lstm_mae || 'N/A'}</td><td>${data.lstm_rmse || 'N/A'}</td><td>${data.lstm_mape || 'N/A'}</td></tr>
                </tbody>
            </table>
        `;

        // Vẽ biểu đồ (giữ nguyên + hiển thị reset button)
        const last24Reversed = (data.last_24_hours || []).slice().reverse();
        const lastRealValue = last24Reversed[last24Reversed.length - 1] || 0;
        const labels = Array.from({length: 24}, (_, i) => `T-${24-i}h`);

        if (chart) chart.destroy();
        chart = new Chart(document.getElementById('chart'), {
            type: 'line',
            data: {
                labels: [...labels, 'Dự báo'],
                datasets: [
                    { 
                        label: 'Thực tế 24h qua', 
                        data: [...last24Reversed, null], 
                        borderColor: '#007bff', 
                        backgroundColor: 'rgba(0,123,255,0.1)', 
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3
                    },
                    { 
                        label: 'Linear Regression (Dự báo)', 
                        data: [...Array(23).fill(null), lastRealValue, data.linear_regression || 0],  
                        borderColor: '#28a745', 
                        borderDash: [10,5],
                        pointRadius: 8,
                        pointHoverRadius: 10
                    },
                    { 
                        label: 'LSTM (Dự báo)', 
                        data: [...Array(23).fill(null), lastRealValue, data.lstm || 0],  
                        borderColor: '#dc3545', 
                        borderDash: [10,5],
                        pointRadius: 8,
                        pointHoverRadius: 10
                    }
                ]
            },
            options: { 
                responsive: true, 
                plugins: { 
                    title: { display: true, text: 'So sánh 2 mô hình dự báo tiêu thụ điện' },
                    zoom: { 
                        zoom: {
                            wheel: { enabled: true },
                            drag: { enabled: true },
                            mode: 'xy'
                        },
                        pan: { 
                            enabled: true, 
                            mode: 'xy',
                            threshold: 2
                        },
                        limits: { x: { min: 'original', max: 'original' } }
                    },
                    legend: { display: true, position: 'top' }
                },
                scales: {
                    y: {  
                        suggestedMin: Math.min(...last24Reversed) - 2000,  
                        suggestedMax: Math.max(...last24Reversed, data.linear_regression, data.lstm) + 2000  
                    }
                },
                interaction: { mode: 'nearest' }
            }
        });
        resetBtn.style.display = 'block';  // Hiển thị nút reset zoom
    } catch (e) {
        alert("Lỗi dự báo! Kiểm tra console F12.");
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'DỰ BÁO 24H TỚI';
        loading.style.display = 'none';
    }
}

function resetZoom() {
    chart.resetZoom();
}
</script>
</body>
</html>