<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Forecast AI</title>
    
    <!-- Bootstrap 5 (giữ lại để giao diện đẹp) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: #007bff;
            color: white;
            border-radius: 10px;
        }
        
        .step {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .step h4 {
            color: #007bff;
            margin-bottom: 15px;
        }
        
        .btn {
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .result-box {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #007bff;
        }
        
        .alert {
            margin-top: 10px;
        }
        
        .metric-box {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 5px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header đơn giản -->
        <div class="header">
            <h2>Energy Forecast AI</h2>
            <p>Dự báo tiêu thụ điện năng bằng AI</p>
        </div>

        <!-- Bước 1: Upload dữ liệu -->
        <div class="step" id="step-upload">
            <h4>1. Tải lên dữ liệu</h4>
            <p>Chọn file CSV chứa dữ liệu tiêu thụ điện</p>
            
            <div class="alert alert-info">
                <strong>Lưu ý:</strong> Tải dữ liệu từ 
                <a href="https://www.kaggle.com/datasets/nicholasjhana/energy-consumption-generation-prices-and-weather" 
                   target="_blank">Kaggle Energy Dataset</a>
            </div>
            
            <form id="uploadForm">
                <div class="mb-3">
                    <input class="form-control" type="file" id="fileInput" accept=".csv">
                </div>
                <button type="submit" class="btn btn-primary">
                    Upload & Phân tích
                </button>
            </form>
            
            <div id="uploadResult"></div>
        </div>

        <!-- Bước 2: Xem thông tin dữ liệu -->
        <div class="step" id="step-analyze" style="display: none;">
            <h4>2. Thông tin dữ liệu</h4>
            <p>Xem tổng quan về dữ liệu đã upload</p>
            
            <button id="loadSummaryBtn" class="btn btn-info">
                Hiển thị thông tin
            </button>
            
            <div id="dataSummary">
                <p class="text-muted">Chưa có dữ liệu. Hãy upload file trước.</p>
            </div>
        </div>

        <!-- Bước 3: Huấn luyện mô hình -->
        <div class="step" id="step-train" style="display: none;">
            <h4>3. Huấn luyện mô hình</h4>
            <p>Chọn mô hình để huấn luyện</p>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <h5>LSTM Model</h5>
                        <p>Dự báo chuỗi thời gian</p>
                        <button id="trainLSTMBtn" class="btn btn-primary">
                            Huấn luyện LSTM
                        </button>
                    </div>
                    <div id="lstmResult"></div>
                </div>
                
                <div class="col-md-6">
                    <div class="mb-3">
                        <h5>ARIMA Model</h5>
                        <p>Phân tích chuỗi thời gian</p>
                        <button id="trainARIMABtn" class="btn btn-warning">
                            Huấn luyện ARIMA
                        </button>
                    </div>
                    <div id="arimaResult"></div>
                </div>
            </div>
        </div>

        <!-- Bước 4: Tạo dự báo -->
        <div class="step" id="step-forecast" style="display: none;">
            <h4>4. Tạo dự báo</h4>
            <p>Dự báo tiêu thụ điện trong tương lai</p>
            
            <div class="row mb-3">
                <div class="col-md-4">
                    <label>Số giờ dự báo:</label>
                    <input type="number" id="forecastHours" class="form-control" value="24" min="1" max="168">
                </div>
                <div class="col-md-8 d-flex align-items-end">
                    <button id="generateForecastBtn" class="btn btn-success">
                        Tạo dự báo
                    </button>
                </div>
            </div>
            
            <div id="forecastResult"></div>
        </div>

        <!-- Bước 5: So sánh mô hình -->
        <div class="step" id="step-compare" style="display: none;">
            <h4>5. So sánh mô hình</h4>
            <p>Xem mô hình nào tốt hơn</p>
            
            <button id="compareModelsBtn" class="btn btn-dark">
                So sánh LSTM vs ARIMA
            </button>
            
            <div id="comparisonResult" class="mt-3">
                <p class="text-muted">Huấn luyện cả 2 mô hình trước để so sánh.</p>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- JavaScript đơn giản -->
    <script>
        // Hiển thị loading
        function showLoading(elementId, message = "Đang xử lý...") {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `
                    <div class="alert alert-info">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        ${message}
                    </div>
                `;
            }
        }

        // Hiển thị kết quả
        function showResult(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            if (element) {
                const alertType = isError ? 'alert-danger' : 'alert-success';
                element.innerHTML = `
                    <div class="alert ${alertType}">
                        ${message}
                    </div>
                `;
            }
        }

        // Hiển thị tất cả các bước
        function showAllSteps() {
            document.getElementById('step-analyze').style.display = 'block';
            document.getElementById('step-train').style.display = 'block';
            document.getElementById('step-forecast').style.display = 'block';
            document.getElementById('step-compare').style.display = 'block';
        }

        // 1. Xử lý upload file
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showResult('uploadResult', 'Vui lòng chọn file CSV', true);
                return;
            }
            
            showLoading('uploadResult', 'Đang upload và phân tích...');
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showResult('uploadResult', ` ${result.message}`);
                    showAllSteps();
                } else {
                    showResult('uploadResult', ` ${result.message}`, true);
                }
            } catch (error) {
                showResult('uploadResult', `Lỗi: ${error.message}`, true);
            }
        });

        // 2. Load thông tin dữ liệu
        document.getElementById('loadSummaryBtn').addEventListener('click', async () => {
            showLoading('dataSummary', 'Đang tải thông tin...');
            
            try {
                const response = await fetch('/summary');
                const result = await response.json();
                
                if (result.success) {
                    const summary = result.data;
                    let html = `
                        <div class="result-box">
                            <p><strong>File:</strong> ${result.filename}</p>
                            <p><strong>Cột mục tiêu:</strong> ${result.targetColumn}</p>
                            <p><strong>Số dòng:</strong> ${summary.rowCount}</p>
                            <p><strong>Số cột:</strong> ${summary.columnCount}</p>
                    `;
                    
                    if (summary.statistics && result.targetColumn && summary.statistics[result.targetColumn]) {
                        const stats = summary.statistics[result.targetColumn];
                        html += `
                            <h6>Thống kê (${result.targetColumn}):</h6>
                            <div class="row">
                                <div class="col-3"><div class="metric-box">Trung bình<br><strong>${parseFloat(stats.mean).toFixed(2)}</strong></div></div>
                                <div class="col-3"><div class="metric-box">Min<br><strong>${parseFloat(stats.min).toFixed(2)}</strong></div></div>
                                <div class="col-3"><div class="metric-box">Max<br><strong>${parseFloat(stats.max).toFixed(2)}</strong></div></div>
                                <div class="col-3"><div class="metric-box">Số lượng<br><strong>${stats.count}</strong></div></div>
                            </div>
                        `;
                    }
                    
                    html += `</div>`;
                    document.getElementById('dataSummary').innerHTML = html;
                } else {
                    showResult('dataSummary', result.message, true);
                }
            } catch (error) {
                showResult('dataSummary', `Lỗi: ${error.message}`, true);
            }
        });

        // 3. Huấn luyện LSTM
        document.getElementById('trainLSTMBtn').addEventListener('click', async () => {
            showLoading('lstmResult', 'Đang huấn luyện LSTM...');
            document.getElementById('trainLSTMBtn').disabled = true;
            
            try {
                const response = await fetch('/train/lstm', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    const metrics = result.metrics;
                    document.getElementById('lstmResult').innerHTML = `
                        <div class="result-box">
                            <p><strong>✓ ${result.message}</strong></p>
                            <div class="row">
                                <div class="col-3"><div class="metric-box">MAE<br><strong>${parseFloat(metrics.mae).toFixed(2)}</strong></div></div>
                                <div class="col-3"><div class="metric-box">RMSE<br><strong>${parseFloat(metrics.rmse).toFixed(2)}</strong></div></div>
                                <div class="col-3"><div class="metric-box">MAPE<br><strong>${parseFloat(metrics.mape).toFixed(2)}%</strong></div></div>
                                <div class="col-3"><div class="metric-box">Thời gian<br><strong>${parseFloat(metrics.trainingTime).toFixed(2)}s</strong></div></div>
                            </div>
                        </div>
                    `;
                } else {
                    showResult('lstmResult', result.message, true);
                }
            } catch (error) {
                showResult('lstmResult', `Lỗi: ${error.message}`, true);
            } finally {
                document.getElementById('trainLSTMBtn').disabled = false;
            }
        });

        // 4. Huấn luyện ARIMA
        document.getElementById('trainARIMABtn').addEventListener('click', async () => {
            showLoading('arimaResult', 'Đang huấn luyện ARIMA...');
            document.getElementById('trainARIMABtn').disabled = true;
            
            try {
                const response = await fetch('/train/arima', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    const metrics = result.metrics;
                    document.getElementById('arimaResult').innerHTML = `
                        <div class="result-box">
                            <p><strong>✓ ${result.message}</strong></p>
                            <div class="row">
                                <div class="col-3"><div class="metric-box">MAE<br><strong>${parseFloat(metrics.mae).toFixed(2)}</strong></div></div>
                                <div class="col-3"><div class="metric-box">RMSE<br><strong>${parseFloat(metrics.rmse).toFixed(2)}</strong></div></div>
                                <div class="col-3"><div class="metric-box">MAPE<br><strong>${parseFloat(metrics.mape).toFixed(2)}%</strong></div></div>
                                <div class="col-3"><div class="metric-box">Thời gian<br><strong>${parseFloat(metrics.trainingTime).toFixed(2)}s</strong></div></div>
                            </div>
                        </div>
                    `;
                } else {
                    showResult('arimaResult', result.message, true);
                }
            } catch (error) {
                showResult('arimaResult', `Lỗi: ${error.message}`, true);
            } finally {
                document.getElementById('trainARIMABtn').disabled = false;
            }
        });

        // 5. Tạo dự báo
        document.getElementById('generateForecastBtn').addEventListener('click', async () => {
            const hours = document.getElementById('forecastHours').value;
            
            if (!hours || hours < 1) {
                showResult('forecastResult', 'Vui lòng nhập số giờ hợp lệ', true);
                return;
            }
            
            showLoading('forecastResult', `Đang tạo dự báo ${hours} giờ...`);
            
            try {
                const response = await fetch(`/forecast?hours=${hours}`);
                const result = await response.json();
                
                if (result.success) {
                    let html = `
                        <div class="result-box">
                            <p><strong>✓ ${result.message}</strong></p>
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>LSTM Forecast</h6>
                    `;
                    
                    if (result.lstmForecast && result.lstmForecast.length > 0) {
                        html += `<p>Giờ tiếp theo: <strong>${parseFloat(result.lstmForecast[0]).toFixed(2)}</strong></p>`;
                        html += `<p>5 giờ đầu:</p><ul>`;
                        for (let i = 0; i < Math.min(5, result.lstmForecast.length); i++) {
                            html += `<li>Giờ ${i+1}: ${parseFloat(result.lstmForecast[i]).toFixed(2)}</li>`;
                        }
                        html += `</ul>`;
                    }
                    
                    html += `
                                </div>
                                <div class="col-md-6">
                                    <h6>ARIMA Forecast</h6>
                    `;
                    
                    if (result.arimaForecast && result.arimaForecast.length > 0) {
                        html += `<p>Giờ tiếp theo: <strong>${parseFloat(result.arimaForecast[0]).toFixed(2)}</strong></p>`;
                        html += `<p>5 giờ đầu:</p><ul>`;
                        for (let i = 0; i < Math.min(5, result.arimaForecast.length); i++) {
                            html += `<li>Giờ ${i+1}: ${parseFloat(result.arimaForecast[i]).toFixed(2)}</li>`;
                        }
                        html += `</ul>`;
                    }
                    
                    html += `
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('forecastResult').innerHTML = html;
                } else {
                    showResult('forecastResult', result.message, true);
                }
            } catch (error) {
                showResult('forecastResult', `Lỗi: ${error.message}`, true);
            }
        });

        // 6. So sánh mô hình
        document.getElementById('compareModelsBtn').addEventListener('click', async () => {
            showLoading('comparisonResult', 'Đang so sánh mô hình...');
            
            try {
                const response = await fetch('/compare');
                const result = await response.json();
                
                if (result.success) {
                    const lstm = result.lstm;
                    const arima = result.arima;
                    
                    let html = `
                        <div class="result-box">
                            <h5>Kết quả so sánh</h5>
                            <p>Mô hình tốt nhất: <strong>${result.bestModel}</strong> (tốt hơn ${parseFloat(result.improvement).toFixed(1)}%)</p>
                            
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>Chỉ số</th>
                                        <th>LSTM</th>
                                        <th>ARIMA</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>MAE</td>
                                        <td>${parseFloat(lstm.mae).toFixed(2)}</td>
                                        <td>${parseFloat(arima.mae).toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td>RMSE</td>
                                        <td>${parseFloat(lstm.rmse).toFixed(2)}</td>
                                        <td>${parseFloat(arima.rmse).toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td>MAPE</td>
                                        <td>${parseFloat(lstm.mape).toFixed(2)}%</td>
                                        <td>${parseFloat(arima.mape).toFixed(2)}%</td>
                                    </tr>
                                    <tr>
                                        <td>Thời gian huấn luyện</td>
                                        <td>${parseFloat(lstm.trainingTime).toFixed(2)}s</td>
                                        <td>${parseFloat(arima.trainingTime).toFixed(2)}s</td>
                                    </tr>
                                </tbody>
                            </table>
                            
                            <div class="alert alert-info">
                                <strong>Giải thích:</strong> 
                                MAE, RMSE, MAPE càng nhỏ càng tốt. 
                                Thời gian huấn luyện càng ngắn càng tốt.
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('comparisonResult').innerHTML = html;
                } else {
                    showResult('comparisonResult', result.message, true);
                }
            } catch (error) {
                showResult('comparisonResult', `Lỗi: ${error.message}`, true);
            }
        });

        // Khởi tạo
        console.log('Energy Forecast AI - Phiên bản đơn giản');
    </script>
</body>
</html>